<!DOCTYPE html>
<html>
<head>
<title>WebRTC sample one</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
</head>
<body onunload="webRTCClose()">
	<div class="jumbotron">
		<video id="local" autoplay></video>
		<video id="remote" autoplay></video>

		Conversations: <select id="conversations"/>
		Conversation id:<input id="convId" type="text"/>
		My name:<input id="memberName" type="text"/>
		<button id="createConv" onclick="createConversation()">Create</button>
		<button id="joinConv"	onclick="joinConversation()">Join</button>
		<button	onclick="refreshConversationList()">Refresh</button>
	</div>
	<script src="js/adapter.js"></script>
	<script src="js/webRTC.js"></script>
	<script src="js/jquery-2.1.3.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script>

		var refreshConversationList = function(){
			$.ajax({
				type: 'GET',
				url: '/WebRTCConference-1.0/conversations/list',
				success: function(data) {
					$('#conversations').find('option').remove().end();
					$.each(data, function (index, value) {
						$('<option>').val(index).text(value).appendTo('#conversations');
					});
				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					alert(textStatus);
		        },
				dataType: "json"
			});
		};

		refreshConversationList();

		var createConversation = function(){
			var convId = $('#convId').val();
			var memberName = $('#memberName').val();
			webRTCConnect();
			webRTC.create(convId, memberName);
			$('#createConv').prop('disabled', true);
			$('#joinConv').prop('disabled', true);
		};

		var joinConversation = function(){
			var convId = $('#conversations').val();
			var memberName = $('#memberName').val();
			webRTCConnect();
			webRTC.join(convId, memberName);
			$('#createConv').prop('disabled', true);
			$('#joinConv').prop('disabled', true);
		};

		var webRTC = null;
		var webRTCConnect = function() {
			var convId = $('#convId').val();
			webRTC = new WebRTC({
				wsURL : 'ws:/localhost:8080/WebRTCConference-1.0/signaling?convId=' + convId,
				mediaConfig : {
					video : true,
					audio : true,
				},
				peerConfig : {
					'iceServers' : [ {
						url : "stun:stun.l.google.com:19302"
					} ]
				},
			});

			webRTC.on('created', function(webRTC, event) {
				console.log(JSON.stringify(event));
				alert('Room with id ' + event.content + ' has been created, share it with your friend to start videochat');
			});

			webRTC.on('joined', function(webRTC, event) {
				console.log(JSON.stringify(event));
				alert('Member with id ' + event.from + ' joined conversation');
			});

			webRTC.on('localStream', function(webRTC, stream) {
				attachMediaStream($('#local')[0], stream.stream);
			});

			webRTC.on('remoteStream', function(webRTC, stream) {
				attachMediaStream($('#remote')[0], stream.stream);
			});

			webRTC.on('left', function(webRTC, event) {
				console.log(JSON.stringify(event));
				alert(event.from + " left!");
			});
		};

		var webRTCClose = function() {
			if(webRTC) {
				webRTC.close();
			}
		};
	</script>

</body>
</html>
